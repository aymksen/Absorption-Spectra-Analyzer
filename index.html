<!DOCTYPE html>
<html>
<head>
    <title>Absorption Spectra Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #011157 0%, #04267d 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        
        h1 {
            font-size: 1.8em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .controls {
            background-color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        #drop-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 15px 25px;
            text-align: center;
            font-size: 0.95em;
            color: #555;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 300px;
        }
        
        #drop-area:hover {
            background-color: #e9ecef;
            border-color: #764ba2;
        }
        
        #drop-area.highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #fff;
        }
        
        .param-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .param-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
            white-space: nowrap;
        }
        
        .param-group input[type="number"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: 80px;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }
        
        .param-group input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        #applyParams {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        
        #applyParams:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        #resetZoom {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        #resetZoom:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #chart-container {
            flex: 1;
            position: relative;
            background: white;
            padding: 20px;
            overflow: hidden;
        }
        
        #chart-container canvas {
            cursor: grab;
        }
        
        #chart-container canvas:active {
            cursor: grabbing;
        }
        
        .info-bar {
            background-color: #f8f9fa;
            padding: 8px 30px;
            text-align: center;
            color: #666;
            font-size: 0.85em;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        .loading {
            display: none;
            padding: 10px;
            text-align: center;
            background-color: #fff3cd;
            color: #856404;
            border-bottom: 1px solid #ffc107;
            font-size: 0.9em;
        }
        
        .loading.active {
            display: block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 28, 168, 0.3);
            border-radius: 50%;
            border-top-color: #160094;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Absorption Spectra Analyzer</h1>
    </div>

    <div class="loading" id="loading">
        <span class="spinner"></span>Processing files...
    </div>

    <div class="controls">
        <div id="drop-area">
            üìÅ Drop files here or click to browse (.xlsx, .xls, .csv)
            <input type="file" id="fileElem" multiple accept=".xlsx, .xls, .csv" style="display: none;">
        </div>
        
        <div class="param-group">
            <label for="windowLength">Window:</label>
            <input type="number" id="windowLength" value="11" min="3" step="2"> 
        </div>
        
        <div class="param-group">
            <label for="polyOrder">Poly Order:</label>
            <input type="number" id="polyOrder" value="2" min="1" max="5">
        </div>
        
        <button id="applyParams">Apply</button>
        <button id="resetZoom">Reset Zoom</button>
    </div>

    <div id="chart-container">
        <canvas id="myChart"></canvas>
    </div>
    
    <div class="info-bar">
        üí° Scroll to zoom ‚Ä¢ Click and drag to pan ‚Ä¢ Double-click to reset
    </div>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileElem = document.getElementById('fileElem');
        const resetZoomButton = document.getElementById('resetZoom');
        const windowLengthInput = document.getElementById('windowLength');
        const polyOrderInput = document.getElementById('polyOrder');
        const applyParamsButton = document.getElementById('applyParams');
        const loadingIndicator = document.getElementById('loading');
        let myChart;
        let loadedFilesData = [];

        const ORIGINAL_SPECTRUM_COLOR = 'rgba(54, 162, 235, 0.5)';
        const PROCESSED_SPECTRUM_COLORS = [
            'rgba(255, 99, 132, 0.9)',
            'rgba(255, 206, 86, 0.9)',
            'rgba(75, 192, 192, 0.9)',
            'rgba(153, 102, 255, 0.9)',
            'rgba(255, 159, 64, 0.9)',
            'rgba(46, 204, 113, 0.9)',
            'rgba(52, 152, 219, 0.9)',
            'rgba(155, 89, 182, 0.9)',
            'rgba(241, 196, 15, 0.9)'
        ];

        // Event listeners
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileElem.click(), false);
        fileElem.addEventListener('change', (event) => loadAndProcessFiles(event.target.files), false);

        resetZoomButton.addEventListener('click', () => {
            if (myChart) {
                myChart.resetZoom();
            }
        });

        applyParamsButton.addEventListener('click', () => {
            if (loadedFilesData.length > 0) {
                processAndRenderAllFiles();
            } else {
                alert("Please load files first before applying parameters.");
            }
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            let dt = e.dataTransfer;
            let files = dt.files;
            loadAndProcessFiles(files);
        }

        async function loadAndProcessFiles(files) {
            loadedFilesData = [];
            loadingIndicator.classList.add('active');
            
            try {
                for (const file of files) {
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    let wavelength = [];
                    let intensity = [];
                    let filenameWithoutExt = file.name.replace(/\.(xlsx|xls|csv)$/i, "");

                    if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                        const data = await readFileAsync(file, 'binary');
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        for (let i = 1; i < json.length; i++) {
                            const w = parseFloat(json[i][0]);
                            const int = parseFloat(json[i][1]);
                            if (!isNaN(w) && !isNaN(int)) {
                                wavelength.push(w);
                                intensity.push(int);
                            }
                        }

                    } else if (fileExtension === 'csv') {
                        const text = await readFileAsync(file, 'text');
                        const lines = text.split('\n');
                        const dataRows = lines.filter(line => !line.startsWith('#') && line.trim() !== '');
                        
                        if (dataRows.length > 1) {
                            const headers = dataRows[0].split(',').map(h => h.trim().toLowerCase());
                            const wavelengthColIndex = headers.indexOf('wavelength');
                            const intensityColIndex = headers.indexOf('intensity');

                            if (wavelengthColIndex === -1 || intensityColIndex === -1) {
                                alert(`CSV file ${file.name} must contain 'wavelength' and 'intensity' columns.`);
                                continue;
                            }

                            for (let i = 1; i < dataRows.length; i++) {
                                const values = dataRows[i].split(',');
                                const w = parseFloat(values[wavelengthColIndex]);
                                const int = parseFloat(values[intensityColIndex]);
                                if (!isNaN(w) && !isNaN(int)) {
                                    wavelength.push(w);
                                    intensity.push(int);
                                }
                            }
                        } else {
                            console.warn(`Skipping file ${file.name}: CSV file is empty or only contains comments.`);
                            continue;
                        }
                    } else {
                        console.warn(`Skipping file ${file.name}: Not a supported file type.`);
                        continue;
                    }

                    if (wavelength.length > 0 && intensity.length > 0) {
                        loadedFilesData.push({
                            name: filenameWithoutExt,
                            wavelength: wavelength,
                            intensity: intensity
                        });
                    } else {
                        console.warn(`Skipping file ${file.name}: No valid numeric data found.`);
                    }
                }

                processAndRenderAllFiles();
            } catch (error) {
                console.error("Error processing files:", error);
                alert("An error occurred while processing files. Please check the console for details.");
            } finally {
                loadingIndicator.classList.remove('active');
            }
        }

        function processAndRenderAllFiles() {
            const allDatasets = [];
            let colorIndex = 0;

            const windowLength = parseInt(windowLengthInput.value);
            const polyOrder = parseInt(polyOrderInput.value);

            if (isNaN(windowLength) || windowLength < 3) {
                alert("Window Length must be a number greater than or equal to 3.");
                return;
            }
            
            if (windowLength % 2 === 0) {
                alert("Window Length must be an odd number. Adjusting to " + (windowLength + 1));
                windowLengthInput.value = windowLength + 1;
                return;
            }
            
            if (isNaN(polyOrder) || polyOrder < 1 || polyOrder > 5) {
                alert("Polynomial Order must be between 1 and 5.");
                return;
            }
            
            if (polyOrder >= windowLength) {
                alert("Polynomial Order must be less than Window Length.");
                return;
            }

            for (const fileData of loadedFilesData) {
                const { name, wavelength, intensity } = fileData;
                const processedData = processSpectrum(wavelength, intensity, windowLength, polyOrder);
                
                allDatasets.push({
                    label: `${name} (Original)`,
                    data: intensity.map((val, i) => ({ x: wavelength[i], y: val })),
                    borderColor: ORIGINAL_SPECTRUM_COLOR,
                    backgroundColor: ORIGINAL_SPECTRUM_COLOR.replace('0.5)', '0.1)'),
                    borderWidth: 1.5,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 3,
                    yAxisID: 'y',
                    tension: 0.1
                });

                allDatasets.push({
                    label: `${name} (Absorbance)`,
                    data: processedData.map((val, i) => ({ x: wavelength[i], y: val })),
                    borderColor: PROCESSED_SPECTRUM_COLORS[colorIndex % PROCESSED_SPECTRUM_COLORS.length],
                    borderWidth: 2.5,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    yAxisID: 'y1',
                    tension: 0.2
                });
                colorIndex++;
            }

            if (allDatasets.length > 0) {
                renderChart(allDatasets);
            } else {
                alert("No valid data to process and display. Please load files.");
            }
        }

        function readFileAsync(file, type) {
            return new Promise((resolve, reject) => {
                let reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                if (type === 'binary') {
                    reader.readAsBinaryString(file);
                } else if (type === 'text') {
                    reader.readAsText(file);
                }
            });
        }

        function savgol_filter(data, window_length, polyorder) {
            if (window_length % 2 === 0) window_length += 1;
            if (window_length > data.length) {
                window_length = data.length % 2 === 0 ? data.length - 1 : data.length;
            }
            if (window_length < 3) window_length = 3;

            const half_window = Math.floor(window_length / 2);
            const smoothed_data = Array(data.length).fill(0);

            for (let i = 0; i < data.length; i++) {
                let sum = 0;
                let weight_sum = 0;
                
                for (let j = -half_window; j <= half_window; j++) {
                    if (i + j >= 0 && i + j < data.length) {
                        const weight = Math.exp(-(j * j) / (2 * (half_window / 2) ** 2));
                        sum += data[i + j] * weight;
                        weight_sum += weight;
                    }
                }
                smoothed_data[i] = sum / weight_sum;
            }
            
            return smoothed_data;
        }

        function processSpectrum(wavelength, intensity, window_length, polyorder) {
            const numericIntensity = intensity.map(Number);
            const smoothed = savgol_filter(numericIntensity, window_length, polyorder);
            const baseline_corrected = smoothed.map(val => val - Math.min(...smoothed));

            const derivative = baseline_corrected.map((val, i, arr) => {
                if (i === 0) return 0;
                return val - arr[i - 1];
            });

            const minDerivative = Math.min(...derivative);
            const maxDerivative = Math.max(...derivative);
            const range = maxDerivative - minDerivative;

            const normalized = derivative.map(val =>
                range === 0 ? 0 : (val - minDerivative) / range
            );

            const absorption = normalized.map(val => -Math.log10(Math.max(val, 1e-6)));

            return absorption;
        }

        function renderChart(datasets) {
            const ctx = document.getElementById('myChart').getContext('2d');

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 500
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Absorption Spectra',
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            color: '#333'
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 12,
                                font: {
                                    size: 11
                                },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            titleFont: {
                                size: 13
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(4);
                                    }
                                    return label;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    speed: 0.1,
                                    modifierKey: null
                                },
                                pinch: {
                                    enabled: true
                                },
                                drag: {
                                    enabled: false
                                },
                                mode: 'xy'
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy',
                                modifierKey: null,
                                scaleMode: 'xy'
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Wavelength (nm)',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                color: '#333'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Intensity (a.u.)',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                color: '#333'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.08)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Absorbance (a.u.)',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                color: '#333'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>